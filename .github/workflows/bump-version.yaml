name: Bump Version

on:
  pull_request:
    branches:
      - '*'
    types:
    - labeled
    - unlabeled
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - graduate
          - increment-rc
          - set-version
      version:
        description: 'Version (required for set-version action only)'
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: bump-version-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

env:
  MISE_VERBOSE: 1

jobs:
  check-semver-label:
    runs-on: ubuntu-latest
    outputs:
      has_version_labels: ${{ steps.label_check.outputs.has_version_labels }}
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # Validate label combination (or gracefully skip if no labels)
      - name: Validate label combination
        id: label_check
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          SEMVER_COUNT=$(echo "$LABELS" | jq -r '[.[]| select(test("^(patch|minor|major)$"))] | length')
          PRERELEASE_COUNT=$(echo "$LABELS" | jq -r '[.[]| select(test("^(rc|alpha|beta)$"))] | length')
          GRADUATE_COUNT=$(echo "$LABELS" | jq -r '[.[]| select(test("^graduate$"))] | length')

          echo "### Label Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Semver labels found: $SEMVER_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release labels found: $PRERELEASE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Graduate labels found: $GRADUATE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # If no version labels, skip gracefully
          if [ "$SEMVER_COUNT" -eq 0 ] && [ "$PRERELEASE_COUNT" -eq 0 ] && [ "$GRADUATE_COUNT" -eq 0 ]; then
            echo "ℹ️  **No version labels found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR will not trigger a version bump." >> $GITHUB_STEP_SUMMARY
            echo "Add one of these labels if you want to bump the version:" >> $GITHUB_STEP_SUMMARY
            echo "- For stable release: \`patch\`, \`minor\`, or \`major\`" >> $GITHUB_STEP_SUMMARY
            echo "- For pre-release: \`rc\`, \`alpha\`, or \`beta\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Skipping version bump"
            echo "has_version_labels=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for multiple semver labels (e.g., patch + minor)
          if [ "$SEMVER_COUNT" -gt 1 ]; then
            echo "❌ **Error:** Multiple semver labels detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please use only ONE of: \`patch\`, \`minor\`, or \`major\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check for multiple pre-release labels (e.g., rc + alpha)
          if [ "$PRERELEASE_COUNT" -gt 1 ]; then
            echo "❌ **Error:** Multiple pre-release labels detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please use only ONE of: \`rc\`, \`alpha\`, or \`beta\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Only one graduate label allowed
          if [ "$GRADUATE_COUNT" -gt 1 ]; then
            echo "❌ **Error:** Multiple graduate labels detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please use only ONE \`graduate\` label" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Graduate is exclusive with all other bump labels
          if [ "$GRADUATE_COUNT" -eq 1 ] && { [ "$SEMVER_COUNT" -gt 0 ] || [ "$PRERELEASE_COUNT" -gt 0 ]; }; then
            echo "❌ **Error:** Graduate label cannot be combined with semver or pre-release labels" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Use only \`graduate\` to remove a pre-release suffix, or use semver/pre-release labels without \`graduate\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ **Label combination is valid**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show what will happen
          if [ "$GRADUATE_COUNT" -eq 1 ]; then
            echo "ℹ️  Graduate label will drop the current pre-release suffix" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$PRERELEASE_COUNT" -eq 1 ] && [ "$SEMVER_COUNT" -eq 0 ]; then
            echo "ℹ️  Pre-release label without semver label will default to patch bump if on stable version" >> $GITHUB_STEP_SUMMARY
          fi

          echo "has_version_labels=true" >> $GITHUB_OUTPUT

  reset-version:
    if: github.event_name == 'pull_request' && github.event.sender.login != 'github-actions[bot]' && needs.check-semver-label.outputs.has_version_labels == 'false'
    needs:
    - check-semver-label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.PAT }}

      - name: Check if version needs reset
        id: check_reset
        run: |
          git fetch origin main

          # Get versions
          BRANCH_VERSION=$(yq '.go.version' .speakeasy/gen.yaml)
          MAIN_VERSION=$(git show origin/main:.speakeasy/gen.yaml | yq '.go.version')

          echo "Branch version: $BRANCH_VERSION"
          echo "Main version: $MAIN_VERSION"

          if [ "$BRANCH_VERSION" != "$MAIN_VERSION" ]; then
            echo "## ⚠️  Version Mismatch Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No version labels present, but branch has version \`$BRANCH_VERSION\` while main has \`$MAIN_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "Resetting to main's version..." >> $GITHUB_STEP_SUMMARY
            echo "needs_reset=true" >> $GITHUB_OUTPUT
          else
            echo "## ✅ Version Already Matches Main" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Branch version \`$BRANCH_VERSION\` matches main. No reset needed." >> $GITHUB_STEP_SUMMARY
            echo "needs_reset=false" >> $GITHUB_OUTPUT
          fi

      - name: Reset version to match main
        if: steps.check_reset.outputs.needs_reset == 'true'
        run: |
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:.speakeasy/gen.yaml | yq '.go.version')

          # Reset only the version field
          yq -i ".go.version = \"$MAIN_VERSION\"" .speakeasy/gen.yaml

          echo "✅ Reset version to: $MAIN_VERSION"

      - name: Commit version reset
        if: steps.check_reset.outputs.needs_reset == 'true'
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
        with:
          add: .speakeasy/gen.yaml
          default_author: github_actions
          message: Reset version to main - no version labels present

  bump-version:
    if: github.event_name == 'pull_request' && github.event.sender.login != 'github-actions[bot]' && needs.check-semver-label.outputs.has_version_labels == 'true'
    needs:
    - check-semver-label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          install_args: github:speakeasy-api/speakeasy

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.PAT }}

      - name: Reset version in gen.yaml to match main
        run: |
          git fetch origin main
          # Get the version from main's gen.yaml
          MAIN_VERSION=$(git show origin/main:.speakeasy/gen.yaml | yq '.go.version')
          echo "Version on main: $MAIN_VERSION"

          # Update only the version field in the branch's gen.yaml, preserving all other changes
          yq -i ".go.version = \"$MAIN_VERSION\"" .speakeasy/gen.yaml

          BRANCH_VERSION=$(yq '.go.version' .speakeasy/gen.yaml)
          echo "Version reset to: $BRANCH_VERSION"

      - name: Set bump (with pre-release support)
        id: bump
        run: |
          # Idempotency check: skip if we just bumped the version
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          LAST_COMMIT_TIME=$(git log -1 --pretty=%ct)
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))

          if [[ "$LAST_COMMIT_MSG" == "Bump .speakeasy/gen.yaml based on label" ]] && [ $TIME_DIFF -lt 300 ]; then
            echo "## ℹ️  Version Already Bumped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The version was bumped ${TIME_DIFF} seconds ago by a previous workflow run." >> $GITHUB_STEP_SUMMARY
            echo "Skipping duplicate bump operation." >> $GITHUB_STEP_SUMMARY
            echo "✅ No action needed - version already set"
            echo "bumped=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          # Extract label types
          SEMVER_BUMP=$(echo "$LABELS" | jq -r '.[] | select(test("^(patch|minor|major)$"))')
          PRERELEASE_TYPE=$(echo "$LABELS" | jq -r '.[] | select(test("^(rc|alpha|beta)$"))')
          GRADUATE_LABEL=$(echo "$LABELS" | jq -r '.[] | select(test("^graduate$"))')

          echo "Semantic bump: '$SEMVER_BUMP'"
          echo "Pre-release type: '$PRERELEASE_TYPE'"
          echo "Graduate: '$GRADUATE_LABEL'"

          if [ -n "$GRADUATE_LABEL" ]; then
            CURRENT_VERSION=$(yq '.management.releaseVersion' .speakeasy/gen.lock)
            echo "Current version: $CURRENT_VERSION"

            if [[ ! "$CURRENT_VERSION" =~ - ]]; then
              echo "❌ Error: Graduate label requires current version to be a pre-release (rc/alpha/beta)"
              exit 1
            fi

            echo "Applying graduate bump to drop pre-release suffix..."
            speakeasy bump graduate

          elif [ -n "$PRERELEASE_TYPE" ]; then
            # Pre-release workflow
            CURRENT_VERSION=$(yq '.management.releaseVersion' .speakeasy/gen.lock)
            echo "Current version: $CURRENT_VERSION"

            # DEFAULT TO PATCH: If no semver bump specified and current is stable, use patch
            if [ -z "$SEMVER_BUMP" ] && [[ ! "$CURRENT_VERSION" =~ - ]]; then
              echo "ℹ️  No semver label specified for stable version, defaulting to patch bump"
              SEMVER_BUMP="patch"
            fi

            # Apply semver bump if specified (or defaulted)
            if [ -n "$SEMVER_BUMP" ]; then
              echo "Applying $SEMVER_BUMP bump..."
              speakeasy bump $SEMVER_BUMP
              # Read from gen.yaml since speakeasy bump writes there (different path than gen.lock)
              BASE_VERSION=$(yq '.go.version' .speakeasy/gen.yaml)
            else
              # Extract base version (remove pre-release suffix if exists)
              if [[ "$CURRENT_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+) ]]; then
                BASE_VERSION="${BASH_REMATCH[1]}"
              else
                BASE_VERSION="$CURRENT_VERSION"
              fi
            fi

            echo "Base version: $BASE_VERSION"

            # Determine pre-release counter
            if [[ "$CURRENT_VERSION" == *"-${PRERELEASE_TYPE}."* ]]; then
              # Increment existing counter for this pre-release type
              COUNTER=$(echo "$CURRENT_VERSION" | grep -oE "${PRERELEASE_TYPE}\.([0-9]+)" | grep -oE "[0-9]+$")
              NEXT_COUNTER=$((COUNTER + 1))
              echo "Incrementing existing ${PRERELEASE_TYPE} counter: $COUNTER -> $NEXT_COUNTER"
            else
              # Start new pre-release series
              NEXT_COUNTER=1
              echo "Starting new ${PRERELEASE_TYPE} series at .1"
            fi

            # Set version with pre-release suffix
            NEW_VERSION="${BASE_VERSION}-${PRERELEASE_TYPE}.${NEXT_COUNTER}"
            echo "Setting version to: $NEW_VERSION"
            speakeasy bump -v "$NEW_VERSION"

          elif [ -n "$SEMVER_BUMP" ]; then
            # Standard semver bump (stable release)
            echo "Applying standard $SEMVER_BUMP bump"
            speakeasy bump $SEMVER_BUMP

          else
            echo "Error: No valid label found"
            exit 1
          fi

          # Verify the version was set (read from gen.yaml where speakeasy bump writes)
          FINAL_VERSION=$(yq '.go.version' .speakeasy/gen.yaml)
          echo "✅ Final version: $FINAL_VERSION"

          # Signal that we actually bumped the version
          echo "bumped=true" >> $GITHUB_OUTPUT

      - name: Commit SDK changes to the PR
        if: steps.bump.outputs.bumped == 'true'
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
        with:
          add: .
          default_author: github_actions
          message: Bump .speakeasy/gen.yaml based on label

  manual-bump:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: main
          token: ${{ secrets.PAT }}

      - name: Configure speakeasy CLI
        run: |
          mkdir -p ~/.speakeasy
          echo 'speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}' > ~/.speakeasy/config.yaml

      - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          install_args: github:speakeasy-api/speakeasy

      - name: Validate current version
        run: |
          CURRENT=$(yq '.management.releaseVersion' .speakeasy/gen.lock)
          echo "Current version: $CURRENT"

          case "${{ github.event.inputs.action }}" in
            graduate)
              if [[ ! "$CURRENT" =~ -rc\.|-alpha\.|-beta\. ]]; then
                echo "Error: Current version '$CURRENT' is not a pre-release"
                echo "Graduate can only be used on RC, alpha, or beta versions"
                exit 1
              fi
              echo "✓ Version is a pre-release, proceeding with graduation"
              ;;
            increment-rc)
              if [[ ! "$CURRENT" =~ -rc\. ]]; then
                echo "Error: Current version '$CURRENT' is not an RC"
                exit 1
              fi
              echo "✓ Version is an RC, proceeding with increment"
              ;;
            set-version)
              if [ -z "${{ github.event.inputs.version }}" ]; then
                echo "Error: version input is required for set-version action"
                exit 1
              fi
              echo "✓ Version specified: ${{ github.event.inputs.version }}"
              ;;
          esac

      - name: Execute action
        run: |
          case "${{ github.event.inputs.action }}" in
            graduate)
              echo "Graduating pre-release to stable version..."
              speakeasy bump graduate
              ;;
            increment-rc)
              CURRENT=$(yq '.management.releaseVersion' .speakeasy/gen.lock)
              if [[ "$CURRENT" =~ (.*-rc\.)([0-9]+) ]]; then
                BASE="${BASH_REMATCH[1]}"
                NUM="${BASH_REMATCH[2]}"
                NEW_VERSION="${BASE}$((NUM + 1))"
                echo "Incrementing RC: $CURRENT -> $NEW_VERSION"
                speakeasy bump -v "$NEW_VERSION"
              else
                echo "Error: Failed to parse RC version from '$CURRENT'"
                exit 1
              fi
              ;;
            set-version)
              echo "Setting version to: ${{ github.event.inputs.version }}"
              speakeasy bump -v "${{ github.event.inputs.version }}"
              ;;
          esac

      - name: Generate SDK
        run: |
          export PATH=${PATH}:$(go env GOPATH)/bin
          make generate.sdk

      - name: Commit SDK changes to main
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
        with:
          add: .
          default_author: github_actions
          message: |
            ${{ github.event.inputs.action }}: automated version update

      - name: Report new version
        run: |
          NEW_VERSION=$(yq '.management.releaseVersion' .speakeasy/gen.lock)
          echo "## ✅ Version Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release will be created automatically by the publish workflow." >> $GITHUB_STEP_SUMMARY
